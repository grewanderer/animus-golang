openapi: 3.0.3
info:
  title: Animus Experiments API
  version: 0.3.0
  description: |
    Experiment registry, immutable run records, and CI integrations.

    In most deployments this service is accessed through the gateway (which enforces auth/RBAC).
servers:
  - url: http://localhost:8083
paths:
  /healthz:
    get:
      summary: Liveness probe
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
  /readyz:
    get:
      summary: Readiness probe
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
  /experiments:
    get:
      summary: List experiments
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
          description: Max number of experiments to return.
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Optional exact name filter.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create an experiment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateExperimentRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Experiment"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Experiment name already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiments/{experiment_id}:
    get:
      summary: Get experiment by ID
      parameters:
        - name: experiment_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Experiment"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiments/{experiment_id}/runs:
    get:
      summary: List experiment runs
      parameters:
        - name: experiment_id
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
          description: Max number of runs to return.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRunListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create an experiment run
      description: |
        Creates an immutable experiment run record.

        If `dataset_version_id` is provided, the run creation is blocked unless the referenced dataset version
        has a `quality_rule_id` and the latest evaluation for that rule/version is `pass`.
      parameters:
        - name: experiment_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateExperimentRunRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRun"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Quality gate failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiments/runs:execute:
    post:
      summary: Execute a training run
      description: |
        Creates an immutable experiment run record in `pending` state, registers an execution intent, and submits the configured
        training executor (Kubernetes Job or Docker).

        Image reference requirements depend on the executor:
        - Kubernetes: `image_ref` must be digest-pinned (e.g. `repo/image@sha256:...`)
        - Docker: `image_ref` may be digest-pinned or a local tag; tags are resolved to an immutable image ID digest and recorded in `image_digest`

        The training container receives environment variables:
        - `RUN_ID`
        - `DATASET_VERSION_ID`
        - `DATAPILOT_URL`
        - `TOKEN` (run-scoped, short-lived)

        Policy evaluation runs before execution. If a policy requires approval, the run is recorded in `pending` state and
        the response returns `202` with approval IDs.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExecuteExperimentRunRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecuteExperimentRunResponse"
        "202":
          description: Approval required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecuteExperimentRunPendingApprovalResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (policy denied)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Experiment not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Quality gate failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "501":
          description: Training executor disabled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs:
    get:
      summary: List experiment runs (all experiments)
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
          description: Max number of runs to return.
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [pending, running, succeeded, failed, canceled]
          description: Optional exact status filter.
        - name: active
          in: query
          required: false
          schema:
            type: boolean
          description: If true, returns only runs in pending/running state.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRunListResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}:
    get:
      summary: Get run by ID
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRun"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/execution:
    get:
      summary: Get run execution record
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRunExecution"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/build-context:
    get:
      summary: Get run build context
      description: |
        Returns the immutable image digest for the run execution and, if available, the associated CI build metadata from the model image registry.
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRunBuildContext"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /execution-ledger:
    get:
      summary: Export execution ledger entries
      parameters:
        - name: run_id
          in: query
          required: false
          schema:
            type: string
          description: Optional run ID filter.
        - name: from
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Optional RFC3339 start timestamp filter.
        - name: to
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Optional RFC3339 end timestamp filter.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
          description: Max number of ledger entries to return.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecutionLedgerExportResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /execution-ledger/{run_id}:
    get:
      summary: Get execution ledger entry by run
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecutionLedgerExportResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/metrics:
    get:
      summary: List run metric samples
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Optional metric name filter.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
          description: Max number of samples to return.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRunMetricsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Ingest run metrics (append-only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestExperimentRunMetricsRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestExperimentRunMetricsResponse"
        "200":
          description: Duplicate (idempotent retry)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestExperimentRunMetricsResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/artifacts:
    get:
      summary: List run artifacts
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: kind
          in: query
          required: false
          schema:
            type: string
            enum: [model, preview, log, file]
          description: Optional artifact kind filter.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
          description: Max number of artifacts to return.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRunArtifactListResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Upload run artifact (append-only)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              additionalProperties: false
              required: [kind, file]
              properties:
                kind:
                  type: string
                  enum: [model, preview, log, file]
                name:
                  type: string
                metadata:
                  type: string
                  description: JSON-encoded object string.
                file:
                  type: string
                  format: binary
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateExperimentRunArtifactResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "502":
          description: Artifact store failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/artifacts/{artifact_id}:
    get:
      summary: Get run artifact by ID
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: artifact_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRunArtifact"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/artifacts/{artifact_id}/download:
    get:
      summary: Download run artifact
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: artifact_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Artifact bytes
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/evidence-bundles:
    get:
      summary: List evidence bundles for a run
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
          description: Max number of bundles to return.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EvidenceBundleListResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create evidence bundle for a run
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateEvidenceBundleResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "502":
          description: Object store error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/evidence-bundles/{bundle_id}:
    get:
      summary: Get evidence bundle metadata
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: bundle_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EvidenceBundle"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/evidence-bundles/{bundle_id}/download:
    get:
      summary: Download evidence bundle
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: bundle_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Evidence bundle zip
          content:
            application/zip:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "502":
          description: Object store error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/evidence-bundles/{bundle_id}/report:
    get:
      summary: Download evidence bundle report
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: bundle_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Evidence bundle PDF report
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "502":
          description: Object store error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/stream:
    get:
      summary: Stream run telemetry (SSE)
      description: |
        Streams run status changes, metric samples, and run timeline events as Server-Sent Events (SSE).
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: after_event_id
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: Optional resume cursor for run events.
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /experiment-runs/{run_id}/events:
    get:
      summary: List run events
      parameters:
        - name: run_id
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
          description: Max number of events to return.
        - name: before_event_id
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: Optional pagination cursor.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRunEventListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create run event (append-only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateExperimentRunEventRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExperimentRunEvent"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /ci/webhook:
    post:
      summary: Attach CI context to a run (signed)
      description: |
        Signed webhook for attaching CI/build metadata to an existing run.

        Signature scheme:
        - `body_sha256_hex = sha256(body_bytes)`
        - `message = ts + "\\n" + upper(method) + "\\n" + body_sha256_hex`
        - `signature = base64url(hmac_sha256(ANIMUS_CI_WEBHOOK_SECRET, message))` (no padding)
      parameters:
        - name: X-Animus-CI-Ts
          in: header
          required: true
          schema:
            type: string
          description: Unix timestamp (seconds).
        - name: X-Animus-CI-Sig
          in: header
          required: true
          schema:
            type: string
          description: base64url(HMAC-SHA256) signature (no padding).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CIWebhookRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CIWebhookResponse"
        "200":
          description: Duplicate (idempotent retry)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CIWebhookResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Signature missing or invalid
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Run not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /ci/report:
    post:
      summary: Report model image build metadata (signed)
      description: |
        Signed webhook for registering model training images built by CI/CD.

        Signature scheme:
        - `body_sha256_hex = sha256(body_bytes)`
        - `message = ts + "\\n" + upper(method) + "\\n" + body_sha256_hex`
        - `signature = base64url(hmac_sha256(ANIMUS_CI_WEBHOOK_SECRET, message))` (no padding)
      parameters:
        - name: X-Animus-CI-Ts
          in: header
          required: true
          schema:
            type: string
          description: Unix timestamp (seconds).
        - name: X-Animus-CI-Sig
          in: header
          required: true
          schema:
            type: string
          description: base64url(HMAC-SHA256) signature (no padding).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CIReportRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CIReportResponse"
        "200":
          description: Duplicate (idempotent retry)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CIReportResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Signature missing or invalid
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /gitlab/webhook:
    post:
      summary: Ingest GitLab governance webhook
      description: |
        Accepts GitLab pipeline or merge request webhooks with governance signals.
        The shared secret is validated via the `X-Gitlab-Token` header.
      parameters:
        - name: X-Gitlab-Token
          in: header
          required: true
          schema:
            type: string
          description: Shared secret token configured in GitLab webhook settings.
        - name: X-Gitlab-Event
          in: header
          required: false
          schema:
            type: string
          description: GitLab event type (e.g., `Pipeline Hook`, `Merge Request Hook`).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GitlabWebhookPayload"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GitlabWebhookResponse"
        "200":
          description: Duplicate (idempotent retry)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GitlabWebhookResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Token missing or invalid
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /model-images:
    get:
      summary: List model images
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
          description: Max number of model images to return.
        - name: repo
          in: query
          required: false
          schema:
            type: string
          description: Optional exact repo filter.
        - name: commit_sha
          in: query
          required: false
          schema:
            type: string
          description: Optional exact commit SHA filter.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModelImageListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /model-images/{image_digest}:
    get:
      summary: Get model image by digest
      parameters:
        - name: image_digest
          in: path
          required: true
          schema:
            type: string
          description: sha256 digest (e.g. `sha256:...`).
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModelImage"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /policies:
    get:
      summary: List policies
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
          description: Max number of policies to return.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create a policy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePolicyRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyVersion"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Policy name already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /policies/{policy_id}:
    get:
      summary: Get policy by ID
      parameters:
        - name: policy_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicySummary"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /policies/{policy_id}/versions:
    get:
      summary: List policy versions
      parameters:
        - name: policy_id
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyVersionListResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create policy version
      parameters:
        - name: policy_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePolicyVersionRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyVersion"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /policy-decisions:
    get:
      summary: List policy decisions
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
        - name: run_id
          in: query
          required: false
          schema:
            type: string
          description: Optional experiment run filter.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyDecisionListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /policy-decisions/{decision_id}:
    get:
      summary: Get policy decision
      parameters:
        - name: decision_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyDecisionDetail"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /policy-approvals:
    get:
      summary: List policy approvals
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [pending, approved, denied]
        - name: run_id
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyApprovalListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /policy-approvals/{approval_id}:
    get:
      summary: Get policy approval
      parameters:
        - name: approval_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyApprovalDetail"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /policy-approvals/{approval_id}/approve:
    post:
      summary: Approve a policy decision
      parameters:
        - name: approval_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PolicyApprovalActionRequest"
      responses:
        "200":
          description: Approved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyApprovalActionResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Conflict
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /policy-approvals/{approval_id}/deny:
    post:
      summary: Deny a policy decision
      parameters:
        - name: approval_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PolicyApprovalActionRequest"
      responses:
        "200":
          description: Denied
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PolicyApprovalActionResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Conflict
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  schemas:
    HealthResponse:
      type: object
      additionalProperties: false
      required: [service, status]
      properties:
        service:
          type: string
        status:
          type: string
    ErrorResponse:
      type: object
      additionalProperties: false
      required: [error, request_id]
      properties:
        error:
          type: string
        request_id:
          type: string
    Experiment:
      type: object
      additionalProperties: false
      required: [experiment_id, name, metadata, created_at, created_by]
      properties:
        experiment_id:
          type: string
        name:
          type: string
        description:
          type: string
        metadata:
          type: object
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    ExperimentListResponse:
      type: object
      additionalProperties: false
      required: [experiments]
      properties:
        experiments:
          type: array
          items:
            $ref: "#/components/schemas/Experiment"
    CreateExperimentRequest:
      type: object
      additionalProperties: false
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string
        metadata:
          type: object
    ExperimentRun:
      type: object
      additionalProperties: false
      required: [run_id, experiment_id, status, started_at, params, metrics]
      properties:
        run_id:
          type: string
        experiment_id:
          type: string
        dataset_version_id:
          type: string
        status:
          type: string
          enum: [pending, running, succeeded, failed, canceled]
        started_at:
          type: string
          format: date-time
        ended_at:
          type: string
          format: date-time
        git_repo:
          type: string
        git_commit:
          type: string
        git_ref:
          type: string
        params:
          type: object
        metrics:
          type: object
        artifacts_prefix:
          type: string
    ExperimentRunListResponse:
      type: object
      additionalProperties: false
      required: [runs]
      properties:
        runs:
          type: array
          items:
            $ref: "#/components/schemas/ExperimentRun"
    ExperimentRunArtifact:
      type: object
      additionalProperties: false
      required: [artifact_id, run_id, kind, object_key, sha256, size_bytes, metadata, created_at, created_by]
      properties:
        artifact_id:
          type: string
        run_id:
          type: string
        kind:
          type: string
          enum: [model, preview, log, file]
        name:
          type: string
        filename:
          type: string
        content_type:
          type: string
        object_key:
          type: string
        sha256:
          type: string
        size_bytes:
          type: integer
        metadata:
          type: object
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    ExperimentRunArtifactListResponse:
      type: object
      additionalProperties: false
      required: [artifacts]
      properties:
        artifacts:
          type: array
          items:
            $ref: "#/components/schemas/ExperimentRunArtifact"
    CreateExperimentRunArtifactResponse:
      type: object
      additionalProperties: false
      required: [artifact]
      properties:
        artifact:
          $ref: "#/components/schemas/ExperimentRunArtifact"
    EvidenceBundle:
      type: object
      additionalProperties: false
      required:
        [
          bundle_id,
          run_id,
          bundle_object_key,
          report_object_key,
          bundle_sha256,
          bundle_size_bytes,
          report_sha256,
          report_size_bytes,
          signature,
          signature_alg,
          created_at,
          created_by
        ]
      properties:
        bundle_id:
          type: string
        run_id:
          type: string
        bundle_object_key:
          type: string
        report_object_key:
          type: string
        bundle_sha256:
          type: string
        bundle_size_bytes:
          type: integer
          format: int64
        report_sha256:
          type: string
        report_size_bytes:
          type: integer
          format: int64
        signature:
          type: string
        signature_alg:
          type: string
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    EvidenceBundleListResponse:
      type: object
      additionalProperties: false
      required: [bundles]
      properties:
        bundles:
          type: array
          items:
            $ref: "#/components/schemas/EvidenceBundle"
    CreateEvidenceBundleResponse:
      type: object
      additionalProperties: false
      required: [bundle]
      properties:
        bundle:
          $ref: "#/components/schemas/EvidenceBundle"
    CreateExperimentRunRequest:
      type: object
      additionalProperties: false
      required: [status]
      properties:
        dataset_version_id:
          type: string
        status:
          type: string
          enum: [pending, running, succeeded, failed, canceled]
        started_at:
          type: string
          format: date-time
        ended_at:
          type: string
          format: date-time
        git_repo:
          type: string
        git_commit:
          type: string
        git_ref:
          type: string
        params:
          type: object
        metrics:
          type: object
        artifacts_prefix:
          type: string
    ExecuteExperimentRunRequest:
      type: object
      additionalProperties: false
      required: [experiment_id, dataset_version_id, image_ref]
      properties:
        experiment_id:
          type: string
        dataset_version_id:
          type: string
        image_ref:
          type: string
          description: |
            Training image reference.

            - Kubernetes executor: must be digest-pinned (e.g. `repo/image@sha256:...`).
            - Docker executor: may be digest-pinned or a local image tag (tags are resolved to an immutable image ID digest and stored in `image_digest`).
        git_repo:
          type: string
          description: Optional Git repository URL/name. If omitted, the service may derive it from the model image registry.
        git_commit:
          type: string
          description: Git commit SHA. Required unless the referenced `image_ref` digest exists in the model image registry.
        git_ref:
          type: string
          description: Optional Git ref (branch/tag) associated with the commit.
        params:
          type: object
        resources:
          type: object
          additionalProperties: true
          description: Optional executor-specific resource hints (e.g. `gpus`, `cpu`, `memory`).
    ExecuteExperimentRunResponse:
      type: object
      additionalProperties: false
      required: [run_id, execution_id, status, datapilot_url]
      properties:
        run_id:
          type: string
        execution_id:
          type: string
        status:
          type: string
          enum: [pending, running]
        datapilot_url:
          type: string
    ExecuteExperimentRunPendingApprovalResponse:
      type: object
      additionalProperties: false
      required: [run_id, status, approval_required, approval_ids]
      properties:
        run_id:
          type: string
        status:
          type: string
          enum: [pending]
        approval_required:
          type: boolean
        approval_ids:
          type: array
          items:
            type: string
    ExperimentRunExecution:
      type: object
      additionalProperties: false
      required: [execution_id, run_id, executor, image_ref, resources, datapilot_url, created_at, created_by]
      properties:
        execution_id:
          type: string
        run_id:
          type: string
        executor:
          type: string
        image_ref:
          type: string
        image_digest:
          type: string
        resources:
          type: object
          additionalProperties: true
        k8s_namespace:
          type: string
        k8s_job_name:
          type: string
        docker_container_id:
          type: string
        datapilot_url:
          type: string
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    ExperimentRunBuildContext:
      type: object
      additionalProperties: false
      required: [run_id, image_ref]
      properties:
        run_id:
          type: string
        image_ref:
          type: string
        image_digest:
          type: string
        repo:
          type: string
        commit_sha:
          type: string
        pipeline_id:
          type: string
        provider:
          type: string
        received_at:
          type: string
          format: date-time
    ExecutionLedgerPolicyDecision:
      type: object
      additionalProperties: false
      required: [decision_id, policy_id, policy_version_id, policy_sha256, context_sha256, decision, created_at, created_by]
      properties:
        decision_id:
          type: string
        policy_id:
          type: string
        policy_version_id:
          type: string
        policy_sha256:
          type: string
        context_sha256:
          type: string
        decision:
          type: string
        rule_id:
          type: string
        reason:
          type: string
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    ExecutionLedgerPolicyApproval:
      type: object
      additionalProperties: false
      required: [approval_id, decision_id, status, requested_at, requested_by]
      properties:
        approval_id:
          type: string
        decision_id:
          type: string
        status:
          type: string
          enum: [pending, approved, denied]
        requested_at:
          type: string
          format: date-time
        requested_by:
          type: string
        decided_at:
          type: string
          format: date-time
        decided_by:
          type: string
        reason:
          type: string
    ExecutionLedgerEntry:
      type: object
      additionalProperties: false
      required: [schema, ledger_id, run_id, execution_id, experiment_id, dataset, image, executor, params, resources, policy, created_at, created_by]
      properties:
        schema:
          type: string
        ledger_id:
          type: string
        run_id:
          type: string
        execution_id:
          type: string
        experiment_id:
          type: string
        dataset:
          type: object
          additionalProperties: false
          required: [dataset_id, version_id, sha256]
          properties:
            dataset_id:
              type: string
            version_id:
              type: string
            sha256:
              type: string
        git:
          type: object
          additionalProperties: false
          properties:
            repo:
              type: string
            commit:
              type: string
            ref:
              type: string
        image:
          type: object
          additionalProperties: false
          required: [ref, digest]
          properties:
            ref:
              type: string
            digest:
              type: string
        executor:
          type: object
          additionalProperties: false
          required: [kind, datapilot_url]
          properties:
            kind:
              type: string
            k8s_namespace:
              type: string
            k8s_job_name:
              type: string
            docker_container_id:
              type: string
            datapilot_url:
              type: string
        params:
          type: object
          additionalProperties: true
        resources:
          type: object
          additionalProperties: true
        policy:
          type: object
          additionalProperties: false
          required: [decisions]
          properties:
            decisions:
              type: array
              items:
                $ref: "#/components/schemas/ExecutionLedgerPolicyDecision"
            approvals:
              type: array
              items:
                $ref: "#/components/schemas/ExecutionLedgerPolicyApproval"
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    ExecutionReplayBundle:
      type: object
      additionalProperties: false
      required: [schema, run_id, experiment_id, dataset_id, dataset_version_id, dataset_sha256, image_ref, image_digest, executor, resources, params]
      properties:
        schema:
          type: string
        run_id:
          type: string
        experiment_id:
          type: string
        dataset_id:
          type: string
        dataset_version_id:
          type: string
        dataset_sha256:
          type: string
        git_repo:
          type: string
        git_commit:
          type: string
        git_ref:
          type: string
        image_ref:
          type: string
        image_digest:
          type: string
        executor:
          type: string
        resources:
          type: object
          additionalProperties: true
        params:
          type: object
          additionalProperties: true
    ExecutionLedgerRecord:
      type: object
      additionalProperties: false
      required: [ledger_id, run_id, execution_id, execution_hash, entry, entry_sha256, replay_bundle, created_at, created_by]
      properties:
        ledger_id:
          type: string
        run_id:
          type: string
        execution_id:
          type: string
        execution_hash:
          type: string
        entry:
          $ref: "#/components/schemas/ExecutionLedgerEntry"
        entry_sha256:
          type: string
        replay_bundle:
          $ref: "#/components/schemas/ExecutionReplayBundle"
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    ExecutionLedgerExportResponse:
      type: object
      additionalProperties: false
      required: [entries, checksum]
      properties:
        entries:
          type: array
          items:
            $ref: "#/components/schemas/ExecutionLedgerRecord"
        checksum:
          type: string
    CIReportRequest:
      type: object
      additionalProperties: true
      required: [image_digest, repo, commit_sha, pipeline_id]
      properties:
        image_digest:
          type: string
          description: sha256 digest (e.g. `sha256:...`).
        repo:
          type: string
        commit_sha:
          type: string
        pipeline_id:
          type: string
        provider:
          type: string
    CIReportResponse:
      type: object
      additionalProperties: true
      required: [status, image_digest, payload_sha256]
      properties:
        status:
          type: string
          enum: [created, duplicate]
        image_digest:
          type: string
        repo:
          type: string
        commit_sha:
          type: string
        pipeline_id:
          type: string
        provider:
          type: string
        payload_sha256:
          type: string
        received_at:
          type: string
          format: date-time
        received_by:
          type: string
    GitlabWebhookPayload:
      type: object
      additionalProperties: true
    GitlabGovernanceRecord:
      type: object
      additionalProperties: false
      required: [governance_id, repo, commit_sha, event_type, received_at, received_by, payload_sha256, signature]
      properties:
        governance_id:
          type: string
        repo:
          type: string
        commit_sha:
          type: string
        ref:
          type: string
        ref_protected:
          type: boolean
        project_id:
          type: integer
          format: int64
        project_path:
          type: string
        pipeline_id:
          type: integer
          format: int64
        pipeline_url:
          type: string
        pipeline_status:
          type: string
        pipeline_source:
          type: string
        merge_request_id:
          type: integer
          format: int64
        merge_request_iid:
          type: integer
          format: int64
        merge_request_url:
          type: string
        merge_request_source_branch:
          type: string
        merge_request_target_branch:
          type: string
        approvals_required:
          type: integer
        approvals_received:
          type: integer
        approvals_approved:
          type: boolean
        event_type:
          type: string
        received_at:
          type: string
          format: date-time
        received_by:
          type: string
        payload_sha256:
          type: string
        signature:
          type: string
    GitlabWebhookResponse:
      type: object
      additionalProperties: false
      required: [status, record]
      properties:
        status:
          type: string
          enum: [created, duplicate]
        record:
          $ref: "#/components/schemas/GitlabGovernanceRecord"
    ModelImage:
      type: object
      additionalProperties: false
      required: [image_digest, repo, commit_sha, pipeline_id, received_at, received_by]
      properties:
        image_digest:
          type: string
        repo:
          type: string
        commit_sha:
          type: string
        pipeline_id:
          type: string
        provider:
          type: string
        received_at:
          type: string
          format: date-time
        received_by:
          type: string
        payload:
          type: object
    PolicySummary:
      type: object
      additionalProperties: false
      required: [policy_id, name, created_at, created_by]
      properties:
        policy_id:
          type: string
        name:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
        latest_version:
          $ref: "#/components/schemas/PolicyVersionSummary"
    PolicyVersionSummary:
      type: object
      additionalProperties: false
      required: [policy_version_id, version, status, spec_sha256, created_at, created_by]
      properties:
        policy_version_id:
          type: string
        version:
          type: integer
        status:
          type: string
          enum: [active, disabled]
        spec_sha256:
          type: string
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    PolicyListResponse:
      type: object
      additionalProperties: false
      required: [policies]
      properties:
        policies:
          type: array
          items:
            $ref: "#/components/schemas/PolicySummary"
    PolicyVersion:
      type: object
      additionalProperties: false
      required: [policy_version_id, policy_id, version, status, spec_yaml, spec, spec_sha256, created_at, created_by]
      properties:
        policy_version_id:
          type: string
        policy_id:
          type: string
        version:
          type: integer
        status:
          type: string
          enum: [active, disabled]
        spec_yaml:
          type: string
        spec:
          type: object
          additionalProperties: true
        spec_sha256:
          type: string
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    PolicyVersionListResponse:
      type: object
      additionalProperties: false
      required: [policy_id, versions]
      properties:
        policy_id:
          type: string
        versions:
          type: array
          items:
            $ref: "#/components/schemas/PolicyVersion"
    CreatePolicyRequest:
      type: object
      additionalProperties: false
      required: [name, spec]
      properties:
        name:
          type: string
        description:
          type: string
        spec:
          type: string
          description: YAML policy specification.
        status:
          type: string
          enum: [active, disabled]
    CreatePolicyVersionRequest:
      type: object
      additionalProperties: false
      required: [spec]
      properties:
        spec:
          type: string
          description: YAML policy specification.
        status:
          type: string
          enum: [active, disabled]
    PolicyDecisionSummary:
      type: object
      additionalProperties: false
      required: [decision_id, policy_id, policy_version_id, policy_sha256, context_sha256, decision, created_at, created_by]
      properties:
        decision_id:
          type: string
        run_id:
          type: string
        policy_id:
          type: string
        policy_name:
          type: string
        policy_version_id:
          type: string
        policy_sha256:
          type: string
        context_sha256:
          type: string
        decision:
          type: string
          enum: [allow, deny, require_approval]
        rule_id:
          type: string
        reason:
          type: string
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
    PolicyDecisionDetail:
      allOf:
        - $ref: "#/components/schemas/PolicyDecisionSummary"
        - type: object
          additionalProperties: false
          required: [context]
          properties:
            context:
              type: object
              additionalProperties: true
    PolicyDecisionListResponse:
      type: object
      additionalProperties: false
      required: [decisions]
      properties:
        decisions:
          type: array
          items:
            $ref: "#/components/schemas/PolicyDecisionSummary"
    PolicyApprovalSummary:
      type: object
      additionalProperties: false
      required: [approval_id, decision_id, status, requested_at, requested_by, policy_id, policy_name, policy_version_id, decision]
      properties:
        approval_id:
          type: string
        decision_id:
          type: string
        run_id:
          type: string
        status:
          type: string
          enum: [pending, approved, denied]
        requested_at:
          type: string
          format: date-time
        requested_by:
          type: string
        decided_at:
          type: string
          format: date-time
        decided_by:
          type: string
        reason:
          type: string
        policy_id:
          type: string
        policy_name:
          type: string
        policy_version_id:
          type: string
        decision:
          type: string
          enum: [allow, deny, require_approval]
        rule_id:
          type: string
    PolicyApprovalDetail:
      allOf:
        - $ref: "#/components/schemas/PolicyApprovalSummary"
        - type: object
          additionalProperties: false
          properties:
            decision_context:
              type: object
              additionalProperties: true
    PolicyApprovalListResponse:
      type: object
      additionalProperties: false
      required: [approvals]
      properties:
        approvals:
          type: array
          items:
            $ref: "#/components/schemas/PolicyApprovalSummary"
    PolicyApprovalActionRequest:
      type: object
      additionalProperties: false
      properties:
        reason:
          type: string
    PolicyApprovalActionResponse:
      type: object
      additionalProperties: false
      required: [approval_id, approval_status, run_id, run_status]
      properties:
        approval_id:
          type: string
        approval_status:
          type: string
          enum: [pending, approved, denied]
        run_id:
          type: string
        run_status:
          type: string
          enum: [pending, running, canceled]
        execution_id:
          type: string
        datapilot_url:
          type: string
        pending:
          type: integer
    ModelImageListResponse:
      type: object
      additionalProperties: false
      required: [model_images]
      properties:
        model_images:
          type: array
          items:
            $ref: "#/components/schemas/ModelImage"
    IngestExperimentRunMetricsRequest:
      type: object
      additionalProperties: false
      required: [step, metrics]
      properties:
        step:
          type: integer
          format: int64
          minimum: 0
        metrics:
          type: object
          additionalProperties: true
          description: Map of metric name to numeric value.
        metadata:
          type: object
          additionalProperties: true
    IngestExperimentRunMetricsResponse:
      type: object
      additionalProperties: false
      required: [run_id, step, inserted, received, request_id]
      properties:
        run_id:
          type: string
        step:
          type: integer
          format: int64
        inserted:
          type: integer
        received:
          type: integer
        request_id:
          type: string
    ExperimentRunMetricSample:
      type: object
      additionalProperties: false
      required: [sample_id, run_id, recorded_at, recorded_by, step, name, value, metadata]
      properties:
        sample_id:
          type: string
        run_id:
          type: string
        recorded_at:
          type: string
          format: date-time
        recorded_by:
          type: string
        step:
          type: integer
          format: int64
        name:
          type: string
        value:
          type: number
        metadata:
          type: object
          additionalProperties: true
    ExperimentRunMetricsResponse:
      type: object
      additionalProperties: false
      required: [run_id, samples]
      properties:
        run_id:
          type: string
        name:
          type: string
        samples:
          type: array
          items:
            $ref: "#/components/schemas/ExperimentRunMetricSample"
    CreateExperimentRunEventRequest:
      type: object
      additionalProperties: false
      required: [message]
      properties:
        occurred_at:
          type: string
          format: date-time
        level:
          type: string
          enum: [debug, info, warn, error]
        message:
          type: string
        metadata:
          type: object
          additionalProperties: true
    ExperimentRunEvent:
      type: object
      additionalProperties: false
      required: [event_id, run_id, occurred_at, actor, level, message, metadata]
      properties:
        event_id:
          type: integer
          format: int64
        run_id:
          type: string
        occurred_at:
          type: string
          format: date-time
        actor:
          type: string
        level:
          type: string
        message:
          type: string
        metadata:
          type: object
          additionalProperties: true
    ExperimentRunEventListResponse:
      type: object
      additionalProperties: false
      required: [run_id, events]
      properties:
        run_id:
          type: string
        events:
          type: array
          items:
            $ref: "#/components/schemas/ExperimentRunEvent"
        next_before_event_id:
          type: integer
          format: int64
    CIWebhookRequest:
      type: object
      additionalProperties: true
      required: [run_id]
      properties:
        run_id:
          type: string
        provider:
          type: string
    CIWebhookResponse:
      type: object
      additionalProperties: true
      required: [context_id, run_id, payload_sha256]
      properties:
        status:
          type: string
        context_id:
          type: string
        run_id:
          type: string
        provider:
          type: string
        payload_sha256:
          type: string
        received_at:
          type: string
          format: date-time
        received_by:
          type: string
        payload:
          type: object
