# Evidence Format and Verification

This document describes the evidence bundle format, execution ledger schema, and verification procedure.

## Evidence bundle overview

Evidence bundles are generated by `POST /api/experiments/experiment-runs/{run_id}/evidence-bundles` and stored in the artifacts bucket.

Each bundle includes:

- `ledger.json`: execution ledger entry (dataset hash, git commit, image digest, policy decisions).
- `lineage.json`: lineage events for the run.
- `audit.json`: audit event slice for the run.
- `policies.json`: policy versions and decisions used.
- `report.pdf`: human-readable compliance report.
- `manifest.json`: file hashes, sizes, and content types.

The evidence bundle record includes:

- `bundle_object_key` (ZIP)
- `report_object_key` (PDF)
- SHA256 hashes and sizes for both
- `signature` and `signature_alg` (`hmac-sha256`)

## Bundle storage layout

The default artifacts prefix is:

```
experiments/${EXPERIMENT_ID}/runs/${RUN_ID}
```

Evidence objects are stored under:

```
${ARTIFACTS_PREFIX}/evidence/${BUNDLE_ID}/bundle.zip
${ARTIFACTS_PREFIX}/evidence/${BUNDLE_ID}/report.pdf
```

If `artifacts_prefix` is set on the run, that prefix is used instead.

## Manifest schema

`manifest.json` contains the list of files with SHA256 and size:

```json
{
  "schema": "animus.evidence_bundle.v1",
  "bundle_id": "bundle_1b9d6a1f",
  "run_id": "run_1f2d3a4b",
  "created_at": "2025-01-10T12:00:00Z",
  "created_by": "dev-user",
  "files": [
    {"name":"audit.json","sha256":"f3a5d42c5c8a12c9b6f30d6c3a2d9c19a58f4186d97dc7e82f7b6b2897a6d2f1","size_bytes":1234,"content_type":"application/json"},
    {"name":"ledger.json","sha256":"b8a1a67d9f4a5c3f2e1b6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7","size_bytes":2345,"content_type":"application/json"},
    {"name":"lineage.json","sha256":"8c3d92fa1b2c3d4e5f60718293a4b5c6d7e8f90123456789abcdef0123456789","size_bytes":3456,"content_type":"application/json"},
    {"name":"policies.json","sha256":"5e4d3c2b1a09876543210fedcba9876543210fedcba9876543210fedcba98765","size_bytes":4567,"content_type":"application/json"},
    {"name":"report.pdf","sha256":"9f8e7d6c5b4a392817161514131211100f0e0d0c0b0a09080706050403020100","size_bytes":5678,"content_type":"application/pdf"}
  ]
}
```

## Execution ledger schema (summary)

Execution ledger entries are emitted under schema `animus.execution_ledger.v1` and include:

- `dataset.dataset_id`, `dataset.version_id`, `dataset.sha256`
- `git.repo`, `git.commit`, `git.ref`
- `image.ref`, `image.digest`
- `executor.kind` (`docker` or `kubernetes_job`)
- `policy.decisions[]` and `policy.approvals[]`

See `open/api/openapi/experiments.yaml` (`ExecutionLedgerEntry`) for the full schema.

## Verification procedure

1) Fetch the evidence bundle record and extract the bundle SHA256:

```bash
bundle_json=$(curl -sS "http://localhost:8080/api/experiments/experiment-runs/${RUN_ID}/evidence-bundles/${BUNDLE_ID}")
BUNDLE_SHA256=$(python3 -c 'import json,sys; print(json.loads(sys.argv[1])["bundle_sha256"])' "${bundle_json}")
```

2) Download the bundle and compute SHA256:

```bash
curl -sS -o evidence.zip \
  "http://localhost:8080/api/experiments/experiment-runs/${RUN_ID}/evidence-bundles/${BUNDLE_ID}/download"

sha256sum evidence.zip
```

3) Verify the bundle signature (HMAC-SHA256 over bundle SHA256). Ensure `ANIMUS_EVIDENCE_SIGNING_SECRET` is set to the signing secret used by the experiments service:

```bash
python3 - <<'PY'
import base64, hashlib, hmac, os, sys
bundle_sha = sys.argv[1]
secret = os.environ.get('ANIMUS_EVIDENCE_SIGNING_SECRET', '').encode('utf-8')
mac = hmac.new(secret, bundle_sha.encode('utf-8'), hashlib.sha256).digest()
print(base64.urlsafe_b64encode(mac).decode('utf-8').rstrip('='))
PY \"$BUNDLE_SHA256\"
```

4) Compare the output with the bundle record `signature`.

## Proving dataset and image usage

To prove that run X used dataset Y and image Z:

1) Fetch execution ledger for the run:

```bash
curl -sS "http://localhost:8080/api/experiments/execution-ledger?run_id=${RUN_ID}&limit=1"
```

2) Confirm:

- `dataset.version_id` and `dataset.sha256` match the dataset version record.
- `image.digest` matches the referenced container image digest.
- `git.commit` matches the code provenance.

3) Cross-reference the same values in `ledger.json` within the evidence bundle.

## Related docs

- `05-api.md`
- `06-cli-and-usage.md`
- `02-security-and-compliance.md`
